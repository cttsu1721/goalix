name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

env:
  VPS_HOST: 170.64.137.4
  VPS_USER: root
  APP_DIR: /opt/apps/goalix

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Only deploy if CI passes (implicitly via push trigger after PR merge)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            echo "=== Deploying Goalix ==="
            cd ${{ env.APP_DIR }}

            # Pull latest changes
            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # Build and restart containers
            echo "Building and restarting containers..."
            docker compose down
            docker compose build --no-cache
            docker compose up -d

            # Note: For schema changes, run migrations manually:
            # docker run --rm --network n8n-docker-caddy_n8n_network \
            #   -v /opt/apps/goalix/prisma:/app/prisma -w /app \
            #   -e DATABASE_URL="$DATABASE_URL" \
            #   node:22-alpine sh -c "npm i prisma@6.19.1 && npx prisma migrate deploy"

            # Health check
            echo "Waiting for app to start..."
            sleep 10

            echo "Running health check..."
            curl -f http://localhost:3000/api/health || exit 1

            echo "=== Deployment complete ==="

      - name: Notify on failure
        if: failure()
        run: |
          echo "Deployment failed! Check the logs above."
          # Add Slack/Discord notification here if needed

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 15

      - name: Health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://goal.quantumdigitalplus.com/api/health)
          if [ "$response" != "200" ]; then
            echo "Health check failed with status: $response"
            exit 1
          fi
          echo "Health check passed!"

      - name: Smoke test - Landing page
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://goal.quantumdigitalplus.com)
          if [ "$response" != "200" ]; then
            echo "Landing page check failed with status: $response"
            exit 1
          fi
          echo "Landing page check passed!"
