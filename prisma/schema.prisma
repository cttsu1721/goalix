generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum GoalCategory {
  HEALTH
  WEALTH
  RELATIONSHIPS
  CAREER
  PERSONAL_GROWTH
  LIFESTYLE
  OTHER
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  PAUSED
  ABANDONED
}

enum TaskPriority {
  MIT
  PRIMARY
  SECONDARY
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum StreakType {
  DAILY_PLANNING
  MIT_COMPLETION
  WEEKLY_REVIEW
  MONTHLY_REVIEW
  KAIZEN_CHECKIN
}

enum AIInteractionType {
  GOAL_SHARPEN
  TASK_SUGGEST
  GOAL_SUGGEST
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// User Model
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  timezone      String    @default("UTC")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Gamification
  totalPoints Int @default(0) @map("total_points")
  level       Int @default(1)

  // Relations
  accounts        Account[]
  sessions        Session[]
  dreams          Dream[]
  weeklyGoals     WeeklyGoal[]
  streaks         Streak[]
  earnedBadges    EarnedBadge[]
  aiInteractions  AIInteraction[]
  kaizenCheckins  KaizenCheckin[]

  @@map("users")
}

// Goal Hierarchy Models
model Dream {
  id          String       @id @default(cuid())
  userId      String       @map("user_id")
  title       String
  description String?      @db.Text
  category    GoalCategory
  status      GoalStatus   @default(ACTIVE)
  targetDate  DateTime?    @map("target_date")
  progress    Int          @default(0) // 0-100
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  fiveYearGoals  FiveYearGoal[]

  @@index([userId])
  @@map("dreams")
}

model FiveYearGoal {
  id          String       @id @default(cuid())
  dreamId     String       @map("dream_id")
  title       String
  description String?      @db.Text
  category    GoalCategory
  status      GoalStatus   @default(ACTIVE)
  targetDate  DateTime?    @map("target_date")
  progress    Int          @default(0)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  dream        Dream          @relation(fields: [dreamId], references: [id], onDelete: Cascade)
  oneYearGoals OneYearGoal[]

  @@index([dreamId])
  @@map("five_year_goals")
}

model OneYearGoal {
  id             String       @id @default(cuid())
  fiveYearGoalId String       @map("five_year_goal_id")
  title          String
  description    String?      @db.Text
  category       GoalCategory
  status         GoalStatus   @default(ACTIVE)
  targetDate     DateTime?    @map("target_date")
  progress       Int          @default(0)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  fiveYearGoal FiveYearGoal  @relation(fields: [fiveYearGoalId], references: [id], onDelete: Cascade)
  monthlyGoals MonthlyGoal[]

  @@index([fiveYearGoalId])
  @@map("one_year_goals")
}

model MonthlyGoal {
  id            String       @id @default(cuid())
  oneYearGoalId String       @map("one_year_goal_id")
  title         String
  description   String?      @db.Text
  category      GoalCategory
  status        GoalStatus   @default(ACTIVE)
  targetMonth   DateTime     @map("target_month") // First day of the month
  progress      Int          @default(0)
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  oneYearGoal OneYearGoal  @relation(fields: [oneYearGoalId], references: [id], onDelete: Cascade)
  weeklyGoals WeeklyGoal[]

  @@index([oneYearGoalId])
  @@index([targetMonth])
  @@map("monthly_goals")
}

model WeeklyGoal {
  id            String       @id @default(cuid())
  userId        String       @map("user_id")
  monthlyGoalId String?      @map("monthly_goal_id")
  title         String
  description   String?      @db.Text
  category      GoalCategory
  status        GoalStatus   @default(ACTIVE)
  weekStart     DateTime     @map("week_start") // Monday of the week
  progress      Int          @default(0)
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  monthlyGoal MonthlyGoal? @relation(fields: [monthlyGoalId], references: [id], onDelete: SetNull)
  dailyTasks  DailyTask[]

  @@index([userId])
  @@index([monthlyGoalId])
  @@map("weekly_goals")
}

model DailyTask {
  id                     String       @id @default(cuid())
  weeklyGoalId           String?      @map("weekly_goal_id")
  userId                 String       @map("user_id")
  title                  String
  description            String?      @db.Text
  priority               TaskPriority
  status                 TaskStatus   @default(PENDING)
  scheduledDate          DateTime     @map("scheduled_date") @db.Date
  estimatedMinutes       Int?         @map("estimated_minutes")
  completedAt            DateTime?    @map("completed_at")
  pointsEarned           Int          @default(0) @map("points_earned")
  unlinkedAcknowledged   Boolean      @default(false) @map("unlinked_acknowledged")
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")

  weeklyGoal WeeklyGoal? @relation(fields: [weeklyGoalId], references: [id], onDelete: SetNull)

  @@index([userId, scheduledDate])
  @@index([userId, priority, scheduledDate])
  @@map("daily_tasks")
}

// Gamification Models
model Streak {
  id           String     @id @default(cuid())
  userId       String     @map("user_id")
  type         StreakType
  currentCount Int        @default(0) @map("current_count")
  longestCount Int        @default(0) @map("longest_count")
  lastActionAt DateTime?  @map("last_action_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("streaks")
}

model Badge {
  id          String @id @default(cuid())
  slug        String @unique
  name        String
  description String
  category    String // streak, achievement, category
  iconUrl     String? @map("icon_url")
  criteria    String  @db.Text // JSON string describing unlock criteria

  earnedBadges EarnedBadge[]

  @@map("badges")
}

model EarnedBadge {
  id       String   @id @default(cuid())
  userId   String   @map("user_id")
  badgeId  String   @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([badgeId])
  @@map("earned_badges")
}

// Kaizen Daily Check-in
model KaizenCheckin {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  checkinDate    DateTime @map("checkin_date") @db.Date
  health         Boolean  @default(false)
  relationships  Boolean  @default(false)
  wealth         Boolean  @default(false)
  career         Boolean  @default(false)
  personalGrowth Boolean  @default(false) @map("personal_growth")
  lifestyle      Boolean  @default(false)
  notes          String?  @db.Text
  pointsEarned   Int      @default(0) @map("points_earned")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, checkinDate])
  @@index([userId, checkinDate])
  @@map("kaizen_checkins")
}

// AI Interaction Tracking
model AIInteraction {
  id           String            @id @default(cuid())
  userId       String            @map("user_id")
  type         AIInteractionType
  inputTokens  Int               @map("input_tokens")
  outputTokens Int               @map("output_tokens")
  prompt       String?           @db.Text
  response     String?           @db.Text
  createdAt    DateTime          @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("ai_interactions")
}
