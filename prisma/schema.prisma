generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum GoalCategory {
  HEALTH
  WEALTH
  RELATIONSHIPS
  CAREER
  PERSONAL_GROWTH
  LIFESTYLE
  LIFE_MAINTENANCE
  OTHER
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  PAUSED
  ABANDONED
  ARCHIVED
}

enum TaskPriority {
  MIT
  PRIMARY
  SECONDARY
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum StreakType {
  DAILY_PLANNING
  MIT_COMPLETION
  WEEKLY_REVIEW
  MONTHLY_REVIEW
  KAIZEN_CHECKIN
}

enum AIInteractionType {
  GOAL_SHARPEN
  TASK_SUGGEST
  GOAL_SUGGEST
  VISION_BUILD
  FEEDBACK_ONLY
  GOAL_LINK_SUGGEST
  ASSISTANT_CHAT
}

enum MessageRole {
  USER
  ASSISTANT
}

enum ChallengeType {
  DAILY   // Resets each day
  WEEKLY  // Resets each week
}

enum ChallengeCategory {
  TASKS       // Task completion challenges
  MIT         // MIT-specific challenges
  ALIGNMENT   // Goal alignment challenges
  KAIZEN      // Kaizen check-in challenges
  STREAKS     // Streak-related challenges
  GOALS       // Goal progress challenges
}

enum RecurrencePattern {
  DAILY         // Every day
  WEEKDAYS      // Monday to Friday
  WEEKLY        // Specific days of the week
  CUSTOM        // Every N days
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// User Model
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String?   // Nullable for existing magic link users
  timezone      String    @default("UTC")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Notification preferences
  notifyDailyReminder  Boolean @default(true) @map("notify_daily_reminder")
  notifyWeeklyReview   Boolean @default(true) @map("notify_weekly_review")
  notifyAchievements   Boolean @default(true) @map("notify_achievements")

  // UX preferences
  enableSoundEffects      Boolean @default(false) @map("enable_sound_effects")
  maxMitCount             Int     @default(1) @map("max_mit_count") // 1-3 MITs per day
  showMotivationalQuotes  Boolean @default(true) @map("show_motivational_quotes")

  // Gamification
  totalPoints   Int       @default(0) @map("total_points")
  level         Int       @default(1)
  streakFreezes Int       @default(2) @map("streak_freezes") // Number of available freezes
  lastFreezeAt  DateTime? @map("last_freeze_at") // When last freeze was used

  // Relations
  accounts               Account[]
  sessions               Session[]
  sevenYearVisions       SevenYearVision[]
  threeYearGoals         ThreeYearGoal[]
  oneYearGoals           OneYearGoal[]
  monthlyGoals           MonthlyGoal[]
  weeklyGoals            WeeklyGoal[]
  dailyTasks             DailyTask[]
  recurringTaskTemplates RecurringTaskTemplate[]
  streaks                Streak[]
  earnedBadges           EarnedBadge[]
  aiInteractions         AIInteraction[]
  kaizenCheckins         KaizenCheckin[]
  weeklyReviews          WeeklyReview[]
  monthlyReviews         MonthlyReview[]
  conversations          Conversation[]
  challenges             UserChallenge[]
  mcpApiTokens           MCPApiToken[]

  @@map("users")
}

// Goal Hierarchy Models
model SevenYearVision {
  id          String       @id @default(cuid())
  userId      String       @map("user_id")
  title       String
  description String?      @db.Text
  category    GoalCategory
  status      GoalStatus   @default(ACTIVE)
  targetDate  DateTime?    @map("target_date")
  progress    Int          @default(0) // 0-100
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  threeYearGoals  ThreeYearGoal[]

  @@index([userId])
  @@map("seven_year_visions")
}

model ThreeYearGoal {
  id                 String       @id @default(cuid())
  userId             String       @map("user_id")
  sevenYearVisionId  String?      @map("seven_year_vision_id")
  title              String
  description        String?      @db.Text
  category           GoalCategory
  status             GoalStatus   @default(ACTIVE)
  targetDate         DateTime?    @map("target_date")
  progress           Int          @default(0)
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  sevenYearVision  SevenYearVision?  @relation(fields: [sevenYearVisionId], references: [id], onDelete: SetNull)
  oneYearGoals     OneYearGoal[]

  @@index([userId])
  @@index([sevenYearVisionId])
  @@map("three_year_goals")
}

model OneYearGoal {
  id               String       @id @default(cuid())
  userId           String       @map("user_id")
  threeYearGoalId  String?      @map("three_year_goal_id")
  title            String
  description      String?      @db.Text
  category         GoalCategory
  status           GoalStatus   @default(ACTIVE)
  targetDate       DateTime?    @map("target_date")
  progress         Int          @default(0)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  threeYearGoal  ThreeYearGoal?  @relation(fields: [threeYearGoalId], references: [id], onDelete: SetNull)
  monthlyGoals   MonthlyGoal[]

  @@index([userId])
  @@index([threeYearGoalId])
  @@map("one_year_goals")
}

model MonthlyGoal {
  id            String       @id @default(cuid())
  userId        String       @map("user_id")
  oneYearGoalId String?      @map("one_year_goal_id")
  title         String
  description   String?      @db.Text
  category      GoalCategory
  status        GoalStatus   @default(ACTIVE)
  targetMonth   DateTime     @map("target_month") // First day of the month
  progress      Int          @default(0)
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  oneYearGoal OneYearGoal?  @relation(fields: [oneYearGoalId], references: [id], onDelete: SetNull)
  weeklyGoals WeeklyGoal[]

  @@index([userId])
  @@index([oneYearGoalId])
  @@index([targetMonth])
  @@map("monthly_goals")
}

model WeeklyGoal {
  id            String       @id @default(cuid())
  userId        String       @map("user_id")
  monthlyGoalId String?      @map("monthly_goal_id")
  title         String
  description   String?      @db.Text
  category      GoalCategory
  status        GoalStatus   @default(ACTIVE)
  weekStart     DateTime     @map("week_start") // Monday of the week
  progress      Int          @default(0)
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  monthlyGoal            MonthlyGoal?            @relation(fields: [monthlyGoalId], references: [id], onDelete: SetNull)
  dailyTasks             DailyTask[]
  recurringTaskTemplates RecurringTaskTemplate[]

  @@index([userId])
  @@index([monthlyGoalId])
  @@map("weekly_goals")
}

model DailyTask {
  id                     String       @id @default(cuid())
  userId                 String       @map("user_id")
  weeklyGoalId           String?      @map("weekly_goal_id")
  recurringTemplateId    String?      @map("recurring_template_id")
  title                  String
  description            String?      @db.Text
  priority               TaskPriority
  status                 TaskStatus   @default(PENDING)
  scheduledDate          DateTime     @map("scheduled_date") @db.Date
  estimatedMinutes       Int?         @map("estimated_minutes")
  completedAt            DateTime?    @map("completed_at")
  pointsEarned           Int          @default(0) @map("points_earned")
  unlinkedAcknowledged   Boolean      @default(false) @map("unlinked_acknowledged")
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")

  user              User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  weeklyGoal        WeeklyGoal?             @relation(fields: [weeklyGoalId], references: [id], onDelete: SetNull)
  recurringTemplate RecurringTaskTemplate?  @relation(fields: [recurringTemplateId], references: [id], onDelete: SetNull)
  subtasks          Subtask[]

  @@index([userId, scheduledDate])
  @@index([userId, priority, scheduledDate])
  @@index([recurringTemplateId])
  @@map("daily_tasks")
}

// Subtask - checklist items within a task
model Subtask {
  id          String   @id @default(cuid())
  taskId      String   @map("task_id")
  title       String
  completed   Boolean  @default(false)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  task DailyTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("subtasks")
}

// Recurring Task Template
model RecurringTaskTemplate {
  id                String            @id @default(cuid())
  userId            String            @map("user_id")
  weeklyGoalId      String?           @map("weekly_goal_id")
  title             String
  description       String?           @db.Text
  priority          TaskPriority
  estimatedMinutes  Int?              @map("estimated_minutes")

  // Recurrence settings
  pattern           RecurrencePattern
  daysOfWeek        String?           @map("days_of_week") // JSON array: ["MON", "WED", "FRI"]
  customInterval    Int?              @map("custom_interval") // For CUSTOM: every N days

  // Time range
  startDate         DateTime          @map("start_date") @db.Date
  endDate           DateTime?         @map("end_date") @db.Date

  // Tracking
  isActive          Boolean           @default(true) @map("is_active")
  lastGeneratedAt   DateTime?         @map("last_generated_at")

  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  weeklyGoal   WeeklyGoal? @relation(fields: [weeklyGoalId], references: [id], onDelete: SetNull)
  dailyTasks   DailyTask[]

  @@index([userId, isActive])
  @@map("recurring_task_templates")
}

// Gamification Models
model Streak {
  id           String     @id @default(cuid())
  userId       String     @map("user_id")
  type         StreakType
  currentCount Int        @default(0) @map("current_count")
  longestCount Int        @default(0) @map("longest_count")
  lastActionAt DateTime?  @map("last_action_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("streaks")
}

model Badge {
  id          String @id @default(cuid())
  slug        String @unique
  name        String
  description String
  category    String // streak, achievement, category
  iconUrl     String? @map("icon_url")
  criteria    String  @db.Text // JSON string describing unlock criteria

  earnedBadges EarnedBadge[]

  @@map("badges")
}

model EarnedBadge {
  id       String   @id @default(cuid())
  userId   String   @map("user_id")
  badgeId  String   @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([badgeId])
  @@map("earned_badges")
}

// Kaizen Daily Check-in
model KaizenCheckin {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  checkinDate    DateTime @map("checkin_date") @db.Date
  health         Boolean  @default(false)
  relationships  Boolean  @default(false)
  wealth         Boolean  @default(false)
  career         Boolean  @default(false)
  personalGrowth Boolean  @default(false) @map("personal_growth")
  lifestyle      Boolean  @default(false)
  notes          String?  @db.Text
  pointsEarned   Int      @default(0) @map("points_earned")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, checkinDate])
  @@index([userId, checkinDate])
  @@map("kaizen_checkins")
}

// AI Interaction Tracking
model AIInteraction {
  id              String            @id @default(cuid())
  userId          String            @map("user_id")
  type            AIInteractionType
  inputTokens     Int               @map("input_tokens")
  outputTokens    Int               @map("output_tokens")
  prompt          String?           @db.Text
  response        String?           @db.Text
  feedbackPositive Boolean?         @map("feedback_positive")
  feedbackContext  String?          @map("feedback_context") @db.Text
  createdAt       DateTime          @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([feedbackPositive])
  @@map("ai_interactions")
}

// Weekly Review
model WeeklyReview {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  weekStart         DateTime @map("week_start") @db.Date // Monday of the week

  // Reflection content
  wins              String?  @db.Text
  challenges        String?  @db.Text
  nextWeekFocus     String?  @map("next_week_focus") @db.Text

  // Stats snapshot (captured at review time)
  tasksCompleted    Int      @default(0) @map("tasks_completed")
  totalTasks        Int      @default(0) @map("total_tasks")
  mitCompleted      Int      @default(0) @map("mit_completed")
  mitTotal          Int      @default(0) @map("mit_total")
  pointsEarned      Int      @default(0) @map("points_earned")
  goalAlignmentRate Int      @default(0) @map("goal_alignment_rate") // 0-100

  // Gamification
  reviewPoints      Int      @default(0) @map("review_points") // Points earned for completing review

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStart])
  @@index([userId, weekStart])
  @@map("weekly_reviews")
}

// Monthly Review
model MonthlyReview {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  monthStart        DateTime @map("month_start") @db.Date // First day of the month

  // Reflection content
  wins              String?  @db.Text
  learnings         String?  @db.Text
  nextMonthFocus    String?  @map("next_month_focus") @db.Text

  // Stats snapshot (captured at review time)
  tasksCompleted    Int      @default(0) @map("tasks_completed")
  totalTasks        Int      @default(0) @map("total_tasks")
  mitCompleted      Int      @default(0) @map("mit_completed")
  mitTotal          Int      @default(0) @map("mit_total")
  goalsCompleted    Int      @default(0) @map("goals_completed")
  goalsTotal        Int      @default(0) @map("goals_total")
  pointsEarned      Int      @default(0) @map("points_earned")
  goalAlignmentRate Int      @default(0) @map("goal_alignment_rate") // 0-100
  kaizenCheckinsCount Int    @default(0) @map("kaizen_checkins_count")

  // Gamification
  reviewPoints      Int      @default(0) @map("review_points") // Points earned for completing review

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, monthStart])
  @@index([userId, monthStart])
  @@map("monthly_reviews")
}

// Zen Assistant Conversation Models
model Conversation {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  title     String?  // Optional title, auto-generated from first message
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ConversationMessage[]

  @@index([userId, isActive])
  @@index([userId, createdAt])
  @@map("conversations")
}

model ConversationMessage {
  id             String      @id @default(cuid())
  conversationId String      @map("conversation_id")
  role           MessageRole
  content        String      @db.Text

  // Tool use tracking
  toolCalls      String?     @map("tool_calls") @db.Text // JSON array of tool calls made
  toolResults    String?     @map("tool_results") @db.Text // JSON array of tool results

  // Token usage for this message
  inputTokens    Int?        @map("input_tokens")
  outputTokens   Int?        @map("output_tokens")

  createdAt      DateTime    @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("conversation_messages")
}

// Daily/Weekly Challenges for bonus XP
model UserChallenge {
  id              String            @id @default(cuid())
  userId          String            @map("user_id")

  // Challenge definition
  type            ChallengeType
  category        ChallengeCategory
  slug            String            // Challenge identifier (e.g., "complete_3_tasks", "mit_streak_3")
  title           String
  description     String
  targetValue     Int               @map("target_value") // Target to achieve (e.g., 3 tasks)
  currentValue    Int               @default(0) @map("current_value") // Current progress
  bonusXp         Int               @map("bonus_xp") // XP awarded on completion

  // Time period
  periodStart     DateTime          @map("period_start") @db.Date // Start of day/week
  periodEnd       DateTime          @map("period_end") @db.Date   // End of day/week

  // Status
  isCompleted     Boolean           @default(false) @map("is_completed")
  completedAt     DateTime?         @map("completed_at")
  xpClaimed       Boolean           @default(false) @map("xp_claimed")

  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, periodStart, type])
  @@index([userId, isCompleted])
  @@map("user_challenges")
}

// MCP API Token for external integrations (Claude AI, etc.)
model MCPApiToken {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  name        String    // User-friendly name (e.g., "Claude Desktop", "claude.ai")
  tokenHash   String    @unique @map("token_hash") // SHA-256 hash of the token
  tokenPrefix String    @map("token_prefix") // First 8 chars for identification (e.g., "gzx_abc1")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at") // null = never expires
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("mcp_api_tokens")
}
